<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>トロッコを切り替えずに5人を見殺し vs トロッコを切り替えて一人を殺す 投票サイト</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/vote/static/vote/js/torokko.js"></script>
    <script src="/vote/static/vote/css/torokko.css"></script>

    <style>
      .vote-bar {
        height: 30px;
      }
    </style>
  </head>
  <body>
<main class="container">
  <div class="px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1>トロッコを切り替えずに5人を見殺し vs トロッコを切り替えて一人を殺す</h1>
    <p class="lead">どちらに投票しますか？</p>
  </div>

  <div class="mx-5 p-3">
    <form id="vote-form" class="needs-validation">
      <div class="form-group">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="item" id="item_kinoko" value="kinoko">
          <label class="form-check-label" for="item_kinoko">トロッコを切り替えずに5人を見殺し &#x1f344;</label>
        </div>
      </div>
      <div class="form-group mb-3">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="item" id="item_takenoko" value="takenoko">
          <label class="form-check-label" for="item_takenoko">トロッコを切り替えずに5人を見殺し vs トロッコを切り替えて一人を殺す&#x1f38d;</label>
        </div>
      </div>
      <button type="button" id="vote-button" class="btn btn-primary">投票</button>
    </form>
  </div>

  <div class="mx-5 p-3">
    <h2>投票結果</h2>
    <div class="progress mb-3">
      <div id="kinoko-bar" class="progress-bar bg-success vote-bar" role="progressbar" style="width: 50%">トロッコを切り替えずに5人を見殺し: 0票</div>
    </div>
    <div class="progress">
      <div id="takenoko-bar" class="progress-bar bg-warning vote-bar" role="progressbar" style="width: 50%">トロッコを切り替えて一人を殺す: 0票</div>
    </div>
  </div>
</main>

<script>
  // WebSocket設定
  const chatSocket = new WebSocket('ws://localhost:8000/ws/vote/kinokotakenoko/');

  // 投票ボタンが押された時の処理
  document.querySelector('#vote-button').onclick = function () {
    const selectedItem = document.querySelector('input[name="item"]:checked');
    if (selectedItem) {
        chatSocket.send(JSON.stringify({ 'message': selectedItem.value }));  // 修正: 'vote' を 'message' に変更
    } else {
        alert('項目を選択してください！');
    }
};

  // サーバーからメッセージを受け取った時の処理
  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    if (data.kinoko !== undefined && data.takenoko !== undefined) {
      const total = data.kinoko + data.takenoko;
      const kinokoPercentage = total ? (data.kinoko / total) * 100 : 50;
      const takenokoPercentage = total ? (data.takenoko / total) * 100 : 50;

      document.querySelector('#kinoko-bar').style.width = kinokoPercentage + '%';
      document.querySelector('#kinoko-bar').textContent = `トロッコを切り替えずに5人を見殺し: ${data.kinoko}票`;

      document.querySelector('#takenoko-bar').style.width = takenokoPercentage + '%';
      document.querySelector('#takenoko-bar').textContent = `トロッコを切り替えて一人を殺す: ${data.takenoko}票`;
    }
  };

  chatSocket.onclose = function () {
    console.error('WebSocketが予期せず閉じられました');
  };
</script>

  </body>
</html>