<!doctype html>
<html lang="ja">
  <head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>きのこ vs たけのこ 投票サイト</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/vote/static/vote/js/kinoko.js"></script>
    <link rel="stylesheet" href="{% static 'vote/css/kinoko.css' %}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <style>
        .vote-bar {
            height: 30px;
        }
    </style>
</head>
<body>
<main class="container topic" >
  <div class="header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1>きのこ vs たけのこ</h1>
    <p class="lead">どちらに投票しますか？</p>
  </div>

    <!-- 投票フォーム -->
    <div class="mx-5 p-3">
        <form id="vote-form" class="needs-validation">
            <div class="form-group">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="item" id="item_kinoko" value="kinoko">
                    <label class="form-check-label" for="item_kinoko">きのこ &#x1f344;</label>
                </div>
            </div>
            <div class="form-group mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="item" id="item_takenoko" value="takenoko">
                    <label class="form-check-label" for="item_takenoko">たけのこ &#x1f38d;</label>
                </div>
            </div>
            <button type="button" id="vote-button" class="btn btn-primary">投票</button>
        </form>
    </div>

    <!-- 投票結果表示 -->
    <div class="mx-5 p-3">
        <h2>投票結果</h2>
        <div class="progress mb-3">
            <div id="kinoko-bar" class="progress-bar bg-success vote-bar" role="progressbar" style="width: 50%">きのこ: 0票</div>
        </div>
        <div class="progress">
            <div id="takenoko-bar" class="progress-bar bg-warning vote-bar" role="progressbar" style="width: 50%">たけのこ: 0票</div>
        </div>
        <button id="vote-kinoko" class="btn btn-success">きのこに投票</button>
    <button id="vote-takenoko" class="btn btn-warning">たけのこに投票</button>

    <script>
        function updateBars(votes) {
            $('#kinoko-bar').css('width', votes.kinoko + '%').text('きのこ: ' + votes.kinoko_votes + '票');
            $('#takenoko-bar').css('width', votes.takenoko + '%').text('たけのこ: ' + votes.takenoko_votes + '票');
        }

        $('#vote-kinoko').click(function() {
            $.post('/vote', { choice: 'kinoko' }, function(data) {
                updateBars(data);
            });
        });

        $('#vote-takenoko').click(function() {
            $.post('/vote', { choice: 'takenoko' }, function(data) {
                updateBars(data);
            });
        });
        </script>
    </div>

    <!-- チャット機能 -->
    <div class="mx-5 p-3">
        <h2>チャット</h2>
        <textarea id="chat-log" cols="100" rows="10"></textarea><br>
        <input id="chat-message-input" type="text" size="100"><br>
        <input id="chat-message-submit" type="button" value="Send">
    </div>
    <div class="text-center mt-4">
        <a href="http://127.0.0.1:8000/" class="btn btn-secondary">ホームに戻る</a>
    </div>
</main>

<!-- WebSocketスクリプト -->
<script id="room-name" type="application/json">"kinokotakenoko"</script>
<script>
    // 投票用WebSocket
    const voteSocket = new WebSocket('ws://localhost:8000/ws/vote/kinokotakenoko/');
    document.querySelector('#vote-button').onclick = function () {
        const selectedItem = document.querySelector('input[name="item"]:checked');
        if (selectedItem) {
            voteSocket.send(JSON.stringify({ 'message': selectedItem.value }));
        } else {
            alert('項目を選択してください！');
        }
    };
    voteSocket.onmessage = function (e) {
      const data = JSON.parse(e.data);
      if (data.kinoko !== undefined && data.takenoko !== undefined) {
        const total = data.kinoko + data.takenoko;
        const kinokoPercentage = total ? (data.kinoko / total) * 100 : 50;
        const takenokoPercentage = total ? (data.takenoko / total) * 100 : 50;

        document.querySelector('#kinoko-bar').style.width = kinokoPercentage + '%';
        document.querySelector('#kinoko-bar').textContent = `愛: ${data.kinoko}票`;

        document.querySelector('#takenoko-bar').style.width = takenokoPercentage + '%';
        document.querySelector('#takenoko-bar').textContent = `金: ${data.takenoko}票`;
      }
    };

    // チャット用WebSocket
    const chatSocket = new WebSocket('ws://localhost:8000/ws/vote/kinokotakenoko/');
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        document.querySelector('#chat-log').value += (data.message + '\n');
    };
    chatSocket.onclose = function () {
        console.error('Chat socket closed unexpectedly');
    };
    document.querySelector('#chat-message-submit').onclick = function () {
        const message = document.querySelector('#chat-message-input').value.trim();
        if (message) {
            chatSocket.send(JSON.stringify({ 'message': message }));
            document.querySelector('#chat-message-input').value = '';
        }
    };
</script>
</body>
</html>
